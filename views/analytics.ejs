<%- include("partials/head", { title: "Analytics" }) %>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<%- include("partials/header") %>

<!-- Back Button -->
<div class="mb-4">
    <a href="/" class="inline-flex items-center gap-2 text-gray-400 hover:text-white smooth-transition text-sm">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        Back
    </a>
</div>

<!-- Page Header -->
<div class="mb-5">
    <h2 class="text-xl md:text-2xl font-bold mb-1 flex items-center gap-2">
        <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>
        Analytics Dashboard
    </h2>
    <p class="text-gray-400 text-sm">Track your fitness progress</p>
</div>

<% if (weightData.length === 0 && workoutLogs.length === 0) { %>
<!-- Empty State -->
<div class="bg-gray-800/30 backdrop-blur-lg rounded-xl border border-gray-700/50 p-8 text-center">
    <svg class="w-12 h-12 mx-auto mb-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
    </svg>
    <p class="text-gray-400 text-sm">No data yet. Start tracking your workouts and weight!</p>
</div>
<% } else { %>

<!-- Charts Grid -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">

    <!-- Weight Progress Chart -->
    <% if (weightData.length > 0) { %>
    <div class="bg-gray-800/30 backdrop-blur-lg rounded-xl border border-gray-700/50 p-4">
        <h3 class="text-sm font-semibold mb-3 text-gray-300 flex items-center gap-2">
            <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
            </svg>
            Weight Progress
        </h3>
        <canvas id="weightChart" height="200"></canvas>
    </div>
    <% } %>

    <!-- BMI Progress Chart -->
    <% if (weightData.length > 0) { %>
    <div class="bg-gray-800/30 backdrop-blur-lg rounded-xl border border-gray-700/50 p-4">
        <h3 class="text-sm font-semibold mb-3 text-gray-300 flex items-center gap-2">
            <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            BMI Trend
        </h3>
        <canvas id="bmiChart" height="200"></canvas>
    </div>
    <% } %>

    <!-- Muscle Group Distribution -->
    <% if (muscleDistribution.length > 0) { %>
    <div class="bg-gray-800/30 backdrop-blur-lg rounded-xl border border-gray-700/50 p-4">
        <h3 class="text-sm font-semibold mb-3 text-gray-300 flex items-center gap-2">
            <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
            </svg>
            Muscle Group Distribution
        </h3>
        <canvas id="muscleChart" height="200"></canvas>
    </div>
    <% } %>

    <!-- Workout Frequency -->
    <% if (workoutLogs.length > 0) { %>
    <div class="bg-gray-800/30 backdrop-blur-lg rounded-xl border border-gray-700/50 p-4">
        <h3 class="text-sm font-semibold mb-3 text-gray-300 flex items-center gap-2">
            <svg class="w-4 h-4 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
            </svg>
            Recent Activity
        </h3>
        <div class="space-y-2">
            <div class="flex justify-between items-center text-xs">
                <span class="text-gray-400">Total Workouts</span>
                <span class="font-bold text-white"><%= workoutLogs.length %></span>
            </div>
            <div class="flex justify-between items-center text-xs">
                <span class="text-gray-400">Most Trained</span>
                <span class="font-bold text-purple-400"><%= muscleDistribution[0]?.muscle || 'N/A' %></span>
            </div>
            <div class="flex justify-between items-center text-xs">
                <span class="text-gray-400">Latest Workout</span>
                <span class="font-bold text-blue-400">
                    <%= workoutLogs[0]?.date.toISOString().split('T')[0] || 'N/A' %>
                </span>
            </div>
        </div>
    </div>
    <% } %>

</div>

<!-- Workout Logs Table -->
<% if (workoutLogs.length > 0) { %>
<div class="bg-gray-800/30 backdrop-blur-lg rounded-xl border border-gray-700/50 p-4">
    <h3 class="text-sm font-semibold mb-3 text-gray-300 flex items-center gap-2">
        <svg class="w-4 h-4 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        Workout History
    </h3>

    <div class="overflow-x-auto">
        <table class="w-full text-xs">
            <thead>
                <tr class="text-gray-400 border-b border-gray-700">
                    <th class="text-left py-2 px-2 font-medium">Date</th>
                    <th class="text-left py-2 px-2 font-medium">Exercise</th>
                    <th class="text-left py-2 px-2 font-medium">Muscle</th>
                    <th class="text-center py-2 px-2 font-medium">Sets</th>
                    <th class="text-center py-2 px-2 font-medium">Reps</th>
                    <th class="text-center py-2 px-2 font-medium">Weight</th>
                </tr>
            </thead>
            <tbody>
                <% workoutLogs.slice(0, 20).forEach((log, index) => { %>
                <tr class="border-b border-gray-800/50 hover:bg-gray-800/30 smooth-transition">
                    <td class="py-2 px-2 text-gray-400">
                        <%= log.date.toISOString().split('T')[0] %>
                    </td>
                    <td class="py-2 px-2 text-white font-medium">
                        <%= log.exercise %>
                    </td>
                    <td class="py-2 px-2">
                        <span class="text-purple-400"><%= log.muscle %></span>
                    </td>
                    <td class="py-2 px-2 text-center text-blue-400">
                        <%= log.sets %>
                    </td>
                    <td class="py-2 px-2 text-center text-green-400">
                        <%= log.reps %>
                    </td>
                    <td class="py-2 px-2 text-center text-yellow-400 font-medium">
                        <%= log.weight %> kg
                    </td>
                </tr>
                <% }) %>
            </tbody>
        </table>
    </div>

    <% if (workoutLogs.length > 20) { %>
    <p class="text-xs text-gray-500 mt-3 text-center">
        Showing 20 of <%= workoutLogs.length %> workouts
    </p>
    <% } %>
</div>
<% } %>

<% } %>

<script>
    // Chart.js configuration for minimal, light theme
    const chartConfig = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: false,
                grid: {
                    color: 'rgba(107, 114, 128, 0.1)',
                    drawBorder: false
                },
                ticks: {
                    color: '#9CA3AF',
                    font: { size: 10 }
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    color: '#9CA3AF',
                    font: { size: 9 },
                    maxRotation: 45,
                    minRotation: 45
                }
            }
        }
    };

    <% if (weightData.length > 0) { %>
    // Weight Chart
    const weightCtx = document.getElementById('weightChart').getContext('2d');
    new Chart(weightCtx, {
        type: 'line',
        data: {
            labels: <%- JSON.stringify(weightData.map(d => d.date)) %>,
            datasets: [{
                label: 'Weight (kg)',
                data: <%- JSON.stringify(weightData.map(d => d.weight)) %>,
                borderColor: 'rgb(96, 165, 250)',
                backgroundColor: 'rgba(96, 165, 250, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true,
                pointRadius: 3,
                pointHoverRadius: 5
            }]
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                tooltip: {
                    backgroundColor: 'rgba(31, 41, 55, 0.9)',
                    titleColor: '#fff',
                    bodyColor: '#9CA3AF',
                    borderColor: 'rgba(107, 114, 128, 0.3)',
                    borderWidth: 1,
                    padding: 8,
                    titleFont: { size: 11 },
                    bodyFont: { size: 10 }
                }
            }
        }
    });

    // BMI Chart
    const bmiCtx = document.getElementById('bmiChart').getContext('2d');
    new Chart(bmiCtx, {
        type: 'line',
        data: {
            labels: <%- JSON.stringify(weightData.map(d => d.date)) %>,
            datasets: [{
                label: 'BMI',
                data: <%- JSON.stringify(weightData.map(d => parseFloat(d.bmi))) %>,
                borderColor: 'rgb(74, 222, 128)',
                backgroundColor: 'rgba(74, 222, 128, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true,
                pointRadius: 3,
                pointHoverRadius: 5
            }]
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                tooltip: {
                    backgroundColor: 'rgba(31, 41, 55, 0.9)',
                    titleColor: '#fff',
                    bodyColor: '#9CA3AF',
                    borderColor: 'rgba(107, 114, 128, 0.3)',
                    borderWidth: 1,
                    padding: 8,
                    titleFont: { size: 11 },
                    bodyFont: { size: 10 }
                }
            }
        }
    });
    <% } %>

    <% if (muscleDistribution.length > 0) { %>
    // Muscle Distribution Chart
    const muscleCtx = document.getElementById('muscleChart').getContext('2d');
    const muscleColors = [
        'rgba(147, 51, 234, 0.8)',  // purple
        'rgba(236, 72, 153, 0.8)',  // pink
        'rgba(59, 130, 246, 0.8)',  // blue
        'rgba(34, 197, 94, 0.8)',   // green
        'rgba(251, 146, 60, 0.8)',  // orange
        'rgba(234, 179, 8, 0.8)',   // yellow
        'rgba(14, 165, 233, 0.8)',  // cyan
        'rgba(168, 85, 247, 0.8)'   // violet
    ];

    new Chart(muscleCtx, {
        type: 'doughnut',
        data: {
            labels: <%- JSON.stringify(muscleDistribution.map(m => m.muscle)) %>,
            datasets: [{
                data: <%- JSON.stringify(muscleDistribution.map(m => m.count)) %>,
                backgroundColor: muscleColors,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'right',
                    labels: {
                        color: '#9CA3AF',
                        font: { size: 10 },
                        padding: 8,
                        boxWidth: 12,
                        boxHeight: 12
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(31, 41, 55, 0.9)',
                    titleColor: '#fff',
                    bodyColor: '#9CA3AF',
                    borderColor: 'rgba(107, 114, 128, 0.3)',
                    borderWidth: 1,
                    padding: 8,
                    titleFont: { size: 11 },
                    bodyFont: { size: 10 }
                }
            }
        }
    });
    <% } %>
</script>

<%- include("partials/footer") %>
